<!DOCTYPE html>
<html>
	<head>
		<title>TinyLISP</title>
		<meta charset="utf8"/>
<script type="text/javascript">
var worker, output;

var classes = {
		stdout: "output",
		stdin: "input",
		stderr: "error",
		system: "system",
};

function addout(txt, kind) {
	var lc = output.lastChild;
	if(lc && lc.nodeType == document.ELEMENT_NODE && lc.classList.contains(kind)) {
		lc.textContent += txt;
		return;
	}
	var spn = document.createElement("span");
	spn.textContent = txt;
	spn.classList.add(kind);
	output.appendChild(spn);
}

function recv(e) {
	switch(e.data.type) {
		case "stdout": case "stderr": case "stdin": case "system":
			addout(e.data.text, classes[e.data.type]);
			break;
		default:
			console.log("Unknown message:", e.data);
			break;
	}
}

function onkey(e) {
	if(!worker) return;
	if(!e.ctrlKey) {
		worker.postMessage({type: "keydown", key: e.key});
		e.preventDefault();
	}
}

function onpaste(e) {
	if(!worker) return;
	var data = e.clipboardData.getData("text/plain");
	if(data.length > 0) {
		worker.postMessage({type: "paste", text: data});
	}
}

function init() {
	output = document.querySelector("#output");
	worker = new Worker("worker.js");
	worker.onmessage = recv;
}
document.addEventListener("DOMContentLoaded", init);
document.addEventListener("keydown", onkey);
document.addEventListener("paste", onpaste);
</script>
<style type="text/css">
#output {
	width: 100%;
	height: 512px;
	font-family: monospace;
	white-space: pre-wrap;
}

.error { color: #a00; }
.input { color: #00a; }
.system { color: #707; }
</style>
	</head>
	<body>
		<div id="output"></div>
	</body>
</html>
